<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>2025 年購買原料</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    input[type="text"], input[type="password"], input[type="datetime-local"] {
      padding: 6px; width: 100%; box-sizing: border-box;
    }
    button {
      padding: 8px 12px; margin: 5px; border: none;
      background-color: #4CAF50; color: white; border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background-color: #45a049; }
    .deleteBtn { background-color: red; }
    #loginForm { display: block; }
    #mainContent { display: none; }
  </style>
  <script>
    document.addEventListener('contextmenu', function (e) {
      e.preventDefault();
    });
    document.addEventListener('keydown', function (e) {
      if (e.key === 'F12' || 
          (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) || 
          (e.ctrlKey && e.key === 'U')) {
        e.preventDefault();
        alert("此功能已被禁用！");
        return false;
      }
    });
  </script>
</head>
<body>

  <div id="loginForm">
    <h2>🔒 登入系統</h2>
    <input type="text" id="username" placeholder="用戶名稱" required><br><br>
    <input type="password" id="password" placeholder="密碼" required><br><br>
    <button onclick="checkLogin()">登入</button>
  </div>

  <!-- Nội dung chính (ẩn trước khi đăng nhập) -->
  <div id="mainContent" style="display: none;">
    <h2>🛠 2025 年購買原料</h2>
    <input type="text" id="searchInput" placeholder="搜尋..." onkeyup="searchTable()">
    <table id="reasonTable">
      <thead>
        <tr>
          <th>月份</th>
          <th>訂單編號</th>
          <th>購買日期</th>
          <th>到貨時間</th>
          <th>訂單數量</th>
          <th>原料名稱</th>
          <th>數量</th>
          <th>下單人</th>
          <th>理由與狀態</th>
          <th>退貨天數</th>
          <th>收貨日期</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="secureAction(addRow)">新增一行</button>
    <button onclick="secureAction(saveData)">保存數據</button>
    <button onclick="logout()" style="background-color: gray;">登出</button>
  </div>

  <script>
    const loginPass = "ht1998";
    const editPass = "aa8794";
    const webhookURL = "https://script.google.com/macros/s/AKfycbxROnIHnhudRi6BrpRQo27ADKiRuMwfbUzCH6-tXCijWlsMZQ4et3nM2InH8s9jQlgX/exec";

    let currentUser = "";
    let hasEditPermission = false;
    // Kiểm tra đăng nhập khi tải trang
    window.onload = () => {
  const u = sessionStorage.getItem("user");
  if (u) {
    currentUser = u;
    document.getElementById("loginForm").style.display = "none"; // Ẩn form đăng nhập
    document.getElementById("mainContent").style.display = "block"; // Hiển thị nội dung chính
    loadData(); // Tải dữ liệu sau khi đăng nhập thành công
  }
};

    // Kiểm tra đăng nhập
    function checkLogin() {
  const name = document.getElementById("username").value.trim();
  const pwd = document.getElementById("password").value;

  if (!name) return alert("請輸入用戶名稱");
  if (pwd === loginPass || pwd === editPass) {
    currentUser = name;
    hasEditPermission = (pwd === editPass);
    sessionStorage.setItem("user", name);  // Lưu thông tin đăng nhập trong sessionStorage
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("mainContent").style.display = "block"; // Hiển thị nội dung chính
    loadData();  // Tải dữ liệu sau khi đăng nhập thành công
  } else {
    alert("密碼錯誤！");
  }
}

    // Đăng xuất
    function logout() {
      localStorage.removeItem("user");
      location.reload();  // Đăng xuất và tải lại trang
    }

    // Hành động bảo mật (thêm dòng, lưu dữ liệu...)
    function secureAction(action) {
      if (hasEditPermission) {
        action();
      } else {
        const input = prompt("🔒 請輸入編輯密碼：");
        if (input === editPass) {
          hasEditPermission = true;
          action();
        } else {
          alert("密碼錯誤！");
        }
      }
    }

    function sendToWebhook(data) {
      fetch(webhookURL, {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      });
    }

    function addRow() {
      const table = document.getElementById("reasonTable").getElementsByTagName('tbody')[0];
      const newRow = table.insertRow();

      const fields = [
        '月份', '訂單編號', '購買日期', '到貨時間', '訂單數量', '原料名稱',
        '數量', '下單人', '理由與狀態', '退貨天數', '收貨日期'
      ];

      for (let i = 0; i < fields.length; i++) {
        const cell = newRow.insertCell();
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = fields[i];
        cell.appendChild(input);
      }

      // 最後一列：刪除按鈕
      const deleteCell = newRow.insertCell();
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "刪除";
      deleteBtn.className = "deleteBtn";
      deleteBtn.style.backgroundColor = "red";
      deleteBtn.style.color = "white";
      deleteBtn.onclick = function () {
        secureAction(() => {
          table.deleteRow(newRow.rowIndex - 1);
        });
      };
      deleteCell.appendChild(deleteBtn);
    }

    function calculateDays(row) {
      const purchaseInput = row.cells[3].getElementsByTagName('input')[0];
      const deliveryInput = row.cells[10].getElementsByTagName('input')[0];
      const daysCell = row.cells[9].getElementsByTagName('input')[0];

      if (!purchaseInput || !daysCell) return;

      const today = new Date();
      const purchaseDate = new Date(purchaseInput.value);
      const deliveryDate = deliveryInput?.value ? new Date(deliveryInput.value) : null;

      if (purchaseInput.value && !isNaN(purchaseDate)) {
        const diffTime = deliveryDate && !isNaN(deliveryDate)
          ? deliveryDate - purchaseDate
          : today - purchaseDate;
        const diffDays = Math.ceil(diffTime / (1000 * 3600 * 24));
        daysCell.value = diffDays >= 0 ? diffDays : 0;
      }
    }

    function searchTable() {
      const filter = document.getElementById("searchInput").value.toUpperCase();
      const rows = document.querySelectorAll("#reasonTable tbody tr");
      rows.forEach(row => {
        const txt = row.innerText.toUpperCase();
        row.style.display = txt.includes(filter) ? "" : "none";
      });
    }

    function saveData() {
      const rows = document.querySelectorAll("#reasonTable tbody tr");
      const allData = [];

      rows.forEach(row => {
        const rowData = [];
        for (let i = 0; i < 11; i++) {
          const val = row.cells[i].querySelector("input")?.value || "";
          rowData.push(val);
        }
        rowData.push(currentUser);
        allData.push(rowData);
      });

      fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: allData })
      }).then(res => res.text()).then(txt => {
        alert("數據已保存至雲端！");
      });
    }

    function loadData() {
      fetch(webhookURL)
        .then(res => res.json())
        .then(data => {
          const table = document.getElementById("reasonTable").getElementsByTagName('tbody')[0];
          while (table.rows.length > 0) table.deleteRow(0); // 清除現有資料

          data.forEach(obj => {
            const row = table.insertRow();
            Object.values(obj).forEach(value => {
              const cell = row.insertCell();
              cell.innerText = value || "";
            });
            const deleteCell = row.insertCell();
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "刪除";
            deleteBtn.className = "deleteBtn";
            deleteBtn.style.backgroundColor = "red";
            deleteBtn.style.color = "white";
            deleteBtn.onclick = function () {
              secureAction(() => {
                table.deleteRow(row.rowIndex);
              });
            };
            deleteCell.appendChild(deleteBtn);
          });
        });
    }

    window.onload = () => {
      const u = localStorage.getItem("user");
      if (u) {
        currentUser = u;
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        loadData(); // 登入後載入資料
      }
    };
  </script>

</body>
</html>