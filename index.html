<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>2025 å¹´è³¼è²·åŸæ–™</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    input[type="text"], input[type="password"], input[type="datetime-local"] {
      padding: 6px; width: 100%; box-sizing: border-box;
    }
    button {
      padding: 8px 12px; margin: 5px; border: none;
      background-color: #4CAF50; color: white; border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background-color: #45a049; }
    .deleteBtn { background-color: red; }
    #loginForm { display: block; }
    #mainContent { display: none; }
  </style>
  <script>
    document.addEventListener('contextmenu', function (e) {
      e.preventDefault();
    });
    document.addEventListener('keydown', function (e) {
      if (e.key === 'F12' || 
          (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) || 
          (e.ctrlKey && e.key === 'U')) {
        e.preventDefault();
        alert("æ­¤åŠŸèƒ½å·²è¢«ç¦ç”¨ï¼");
        return false;
      }
    });
  </script>
</head>
<body>

  <div id="loginForm">
    <h2>ğŸ”’ ç™»å…¥ç³»çµ±</h2>
    <input type="text" id="username" placeholder="ç”¨æˆ¶åç¨±" required><br><br>
    <input type="password" id="password" placeholder="å¯†ç¢¼" required><br><br>
    <button onclick="checkLogin()">ç™»å…¥</button>
  </div>

  <!-- Ná»™i dung chÃ­nh (áº©n trÆ°á»›c khi Ä‘Äƒng nháº­p) -->
  <div id="mainContent" style="display: none;">
    <h2>ğŸ›  2025 å¹´è³¼è²·åŸæ–™</h2>
    <input type="text" id="searchInput" placeholder="æœå°‹..." onkeyup="searchTable()">
    <table id="reasonTable">
      <thead>
        <tr>
          <th>æœˆä»½</th>
          <th>è¨‚å–®ç·¨è™Ÿ</th>
          <th>è³¼è²·æ—¥æœŸ</th>
          <th>åˆ°è²¨æ™‚é–“</th>
          <th>è¨‚å–®æ•¸é‡</th>
          <th>åŸæ–™åç¨±</th>
          <th>æ•¸é‡</th>
          <th>ä¸‹å–®äºº</th>
          <th>ç†ç”±èˆ‡ç‹€æ…‹</th>
          <th>é€€è²¨å¤©æ•¸</th>
          <th>æ”¶è²¨æ—¥æœŸ</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="secureAction(addRow)">æ–°å¢ä¸€è¡Œ</button>
    <button onclick="secureAction(saveData)">ä¿å­˜æ•¸æ“š</button>
    <button onclick="logout()" style="background-color: gray;">ç™»å‡º</button>
  </div>

  <script>
    const loginPass = "ht1998";
    const editPass = "aa8794";
    const webhookURL = "https://script.google.com/macros/s/AKfycbxROnIHnhudRi6BrpRQo27ADKiRuMwfbUzCH6-tXCijWlsMZQ4et3nM2InH8s9jQlgX/exec";

    let currentUser = "";
    let hasEditPermission = false;
    // Kiá»ƒm tra Ä‘Äƒng nháº­p khi táº£i trang
    window.onload = () => {
  const u = sessionStorage.getItem("user") || localStorage.getItem("user");
  if (u) {
    currentUser = u;
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    loadData(); // ç™»å…¥å¾Œè¼‰å…¥è³‡æ–™
  }
};

    // Kiá»ƒm tra Ä‘Äƒng nháº­p
    function checkLogin() {
  const name = document.getElementById("username").value.trim();
  const pwd = document.getElementById("password").value;

  if (!name) return alert("è«‹è¼¸å…¥ç”¨æˆ¶åç¨±");
  if (pwd === loginPass || pwd === editPass) {
    currentUser = name;
    hasEditPermission = (pwd === editPass);
    sessionStorage.setItem("user", name);  // LÆ°u thÃ´ng tin Ä‘Äƒng nháº­p trong sessionStorage
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("mainContent").style.display = "block"; // Hiá»ƒn thá»‹ ná»™i dung chÃ­nh
    loadData();  // Táº£i dá»¯ liá»‡u sau khi Ä‘Äƒng nháº­p thÃ nh cÃ´ng
  } else {
    alert("å¯†ç¢¼éŒ¯èª¤ï¼");
  }
}

    // ÄÄƒng xuáº¥t
    function logout() {
      localStorage.removeItem("user");
      location.reload();  // ÄÄƒng xuáº¥t vÃ  táº£i láº¡i trang
    }

    // HÃ nh Ä‘á»™ng báº£o máº­t (thÃªm dÃ²ng, lÆ°u dá»¯ liá»‡u...)
    function secureAction(action) {
      if (hasEditPermission) {
        action();
      } else {
        const input = prompt("ğŸ”’ è«‹è¼¸å…¥ç·¨è¼¯å¯†ç¢¼ï¼š");
        if (input === editPass) {
          hasEditPermission = true;
          action();
        } else {
          alert("å¯†ç¢¼éŒ¯èª¤ï¼");
        }
      }
    }

    function sendToWebhook(data) {
      fetch(webhookURL, {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      });
    }

    function addRow() {
      const table = document.getElementById("reasonTable").getElementsByTagName('tbody')[0];
      const newRow = table.insertRow();

      const fields = [
        'æœˆä»½', 'è¨‚å–®ç·¨è™Ÿ', 'è³¼è²·æ—¥æœŸ', 'åˆ°è²¨æ™‚é–“', 'è¨‚å–®æ•¸é‡', 'åŸæ–™åç¨±',
        'æ•¸é‡', 'ä¸‹å–®äºº', 'ç†ç”±èˆ‡ç‹€æ…‹', 'é€€è²¨å¤©æ•¸', 'æ”¶è²¨æ—¥æœŸ'
      ];

      for (let i = 0; i < fields.length; i++) {
        const cell = newRow.insertCell();
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = fields[i];
        cell.appendChild(input);
      }

      // æœ€å¾Œä¸€åˆ—ï¼šåˆªé™¤æŒ‰éˆ•
      const deleteCell = newRow.insertCell();
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "åˆªé™¤";
      deleteBtn.className = "deleteBtn";
      deleteBtn.style.backgroundColor = "red";
      deleteBtn.style.color = "white";
      deleteBtn.onclick = function () {
        secureAction(() => {
          table.deleteRow(newRow.rowIndex - 1);
        });
      };
      deleteCell.appendChild(deleteBtn);
    }

    function calculateDays(row) {
      const purchaseInput = row.cells[3].getElementsByTagName('input')[0];
      const deliveryInput = row.cells[10].getElementsByTagName('input')[0];
      const daysCell = row.cells[9].getElementsByTagName('input')[0];

      if (!purchaseInput || !daysCell) return;

      const today = new Date();
      const purchaseDate = new Date(purchaseInput.value);
      const deliveryDate = deliveryInput?.value ? new Date(deliveryInput.value) : null;

      if (purchaseInput.value && !isNaN(purchaseDate)) {
        const diffTime = deliveryDate && !isNaN(deliveryDate)
          ? deliveryDate - purchaseDate
          : today - purchaseDate;
        const diffDays = Math.ceil(diffTime / (1000 * 3600 * 24));
        daysCell.value = diffDays >= 0 ? diffDays : 0;
      }
    }

    function searchTable() {
      const filter = document.getElementById("searchInput").value.toUpperCase();
      const rows = document.querySelectorAll("#reasonTable tbody tr");
      rows.forEach(row => {
        const txt = row.innerText.toUpperCase();
        row.style.display = txt.includes(filter) ? "" : "none";
      });
    }

    function saveData() {
      const rows = document.querySelectorAll("#reasonTable tbody tr");
      const allData = [];

      rows.forEach(row => {
        const rowData = [];
        for (let i = 0; i < 11; i++) {
          const val = row.cells[i].querySelector("input")?.value || "";
          rowData.push(val);
        }
        rowData.push(currentUser);
        allData.push(rowData);
      });

      fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: allData })
      }).then(res => res.text()).then(txt => {
        alert("æ•¸æ“šå·²ä¿å­˜è‡³é›²ç«¯ï¼");
      });
    }

    function loadData() {
      fetch(webhookURL)
        .then(res => res.json())
        .then(data => {
          const table = document.getElementById("reasonTable").getElementsByTagName('tbody')[0];
          while (table.rows.length > 0) table.deleteRow(0); // æ¸…é™¤ç¾æœ‰è³‡æ–™

          data.forEach(obj => {
            const row = table.insertRow();
            Object.values(obj).forEach(value => {
              const cell = row.insertCell();
              cell.innerText = value || "";
            });
            const deleteCell = row.insertCell();
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "åˆªé™¤";
            deleteBtn.className = "deleteBtn";
            deleteBtn.style.backgroundColor = "red";
            deleteBtn.style.color = "white";
            deleteBtn.onclick = function () {
              secureAction(() => {
                table.deleteRow(row.rowIndex);
              });
            };
            deleteCell.appendChild(deleteBtn);
          });
        });
    }
  </script>

</body>
</html>