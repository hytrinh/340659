<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€²åº¦è·Ÿè¸ªç³»çµ±</title>
  <style>
    body {
      background-color: #1e1e1e;
      color: #f0f0f0;
      font-family: Arial, sans-serif;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    th, td {
      padding: 8px;
      border: 1px solid #444;
      text-align: center;
    }
    th {
      background-color: #2c2c2c;
    }
    input, button {
      padding: 6px;
      border-radius: 4px;
      border: none;
      margin: 4px 0;
    }
    input {
      background-color: #333;
      color: #fff;
    }
    button {
      background-color: #444;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #666;
    }
    @media screen and (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      tr {
        margin-bottom: 15px;
      }
      td {
        text-align: left;
        padding-left: 50%;
        position: relative;
      }
      td::before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        font-weight: bold;
      }
    }
  </style>
</head>
<body>

<div id="loginForm">
  <h2>ğŸ” ç™»å…¥ç³»çµ±</h2>
  <input type="text" id="username" placeholder="ç”¨æˆ¶åç¨±">
  <input type="password" id="password" placeholder="å¯†ç¢¼">
  <button onclick="checkLogin()">ç™»å…¥</button>
</div>

<div id="mainContent" style="display:none">
  <h2>ğŸ“¦ åŸæ–™é€²åº¦è·Ÿè¸ª</h2>
  <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="ğŸ” æœå°‹...">
  <table id="reasonTable">
    <thead>
      <tr>
        <th>æœˆä»½</th>
        <th>è¨‚å–®ç·¨è™Ÿ</th>
        <th>è³¼è²·æ—¥æœŸ</th>
        <th>åˆ°é‡‡è´­æ™‚é–“</th>
        <th>è§„æ ¼</th>
        <th>åŸæ–™åç¨±</th>
        <th>æ•¸é‡</th>
        <th>ä¸‹å–®äºº</th>
        <th>ç†ç”±èˆ‡ç‹€æ…‹</th>
        <th>ç¸½å¤©æ•¸</th>
        <th>åˆ°è´§æ—¥æœŸ</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="secureAction(addRow)">æ–°å¢ä¸€è¡Œ</button>
  <button onclick="secureAction(saveData)">ä¿å­˜æ•¸æ“š</button>
  <button onclick="logout()" style="background-color: gray;">ç™»å‡º</button>

  <h3>ğŸ“Š çµ±è¨ˆè¡¨ï¼ˆæ¯æœˆï¼‰</h3>
  <table id="summaryTable">
    <thead>
      <tr><th>æœˆä»½</th><th>ç¸½è¨‚å–®æ•¸é‡</th><th>ç¸½åŸæ–™æ•¸é‡</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const loginPass = "ht1998";
const editPass = "aa8794";
const webhookURL = "https://script.google.com/macros/s/AKfycbxROnIHnhudRi6BrpRQo27ADKiRuMwfbUzCH6-tXCijWlsMZQ4et3nM2InH8s9jQlgX/exec";
let currentUser = "";
let hasEditPermission = false;

window.onload = () => {
  const u = sessionStorage.getItem("user") || localStorage.getItem("user");
  if (u) {
    currentUser = u;
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    loadData();
  }
};

function checkLogin() {
  const name = document.getElementById("username").value.trim();
  const pwd = document.getElementById("password").value;
  if (!name) return alert("è«‹è¼¸å…¥ç”¨æˆ¶åç¨±");
  if (pwd === loginPass || pwd === editPass) {
    currentUser = name;
    hasEditPermission = (pwd === editPass);
    sessionStorage.setItem("user", name);
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    loadData();
  } else {
    alert("å¯†ç¢¼éŒ¯èª¤ï¼");
  }
}

function logout() {
  localStorage.removeItem("user");
  sessionStorage.removeItem("user");
  location.reload();
}

function secureAction(action) {
  if (hasEditPermission) {
    action();
  } else {
    const input = prompt("ğŸ”’ è«‹è¼¸å…¥ç·¨è¼¯å¯†ç¢¼ï¼š");
    if (input === editPass) {
      hasEditPermission = true;
      action();
    } else {
      alert("å¯†ç¢¼éŒ¯èª¤ï¼");
    }
  }
}

function addRow() {
  const table = document.getElementById("reasonTable").getElementsByTagName('tbody')[0];
  const newRow = table.insertRow();
  const fields = [
    'æœˆä»½', 'è¨‚å–®ç·¨è™Ÿ', 'è³¼è²·æ—¥æœŸ', 'åˆ°é‡‡è´­æ™‚é–“', 'è¨‚å–®æ•¸é‡',
    'åŸæ–™åç¨±', 'æ•¸é‡', 'ä¸‹å–®äºº', 'ç†ç”±èˆ‡ç‹€æ…‹', 'ç¸½å¤©æ•¸', 'åˆ°è´§æ—¥æœŸ'
  ];
  for (let i = 0; i < fields.length; i++) {
    const cell = newRow.insertCell();
    const input = document.createElement("input");
    input.type = (fields[i].includes("æ—¥æœŸ") || fields[i].includes("æ™‚é–“")) ? "datetime-local" : "text";
    input.placeholder = fields[i];
    if (fields[i] === 'æœˆä»½') {
      const now = new Date();
      const monthText = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      input.value = monthText;
    }
    cell.appendChild(input);
    if (i === 3 || i === 10) {
      input.addEventListener("change", () => {
        calculateDays(newRow);
      });
    }
  }
  const deleteCell = newRow.insertCell();
  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "åˆªé™¤";
  deleteBtn.className = "deleteBtn";
  deleteBtn.style.backgroundColor = "red";
  deleteBtn.style.color = "white";
  deleteBtn.onclick = function () {
    secureAction(() => {
      table.deleteRow(newRow.rowIndex - 1);
    });
  };
  deleteCell.appendChild(deleteBtn);
}

function calculateDays(row) {
  const purchaseInput = row.cells[3].querySelector("input");
  const deliveryInput = row.cells[10].querySelector("input");
  const daysInput = row.cells[9].querySelector("input");

  if (!purchaseInput || !deliveryInput || !daysInput) return;

  const purchaseDate = new Date(purchaseInput.value);
  const deliveryDate = new Date(deliveryInput.value || new Date());

  if (isNaN(purchaseDate.getTime()) || isNaN(deliveryDate.getTime())) return;

  const diffTime = deliveryDate - purchaseDate;
  const diffDays = Math.ceil(diffTime / (1000 * 3600 * 24));
  daysInput.value = diffDays >= 0 ? diffDays : 0;
}
function searchTable() {
  const filter = document.getElementById("searchInput").value.toUpperCase();
  const rows = document.querySelectorAll("#reasonTable tbody tr");
  rows.forEach(row => {
    const txt = row.innerText.toUpperCase();
    row.style.display = txt.includes(filter) ? "" : "none";
  });
}

function saveData() {
  const table = document.querySelector("#detailTable tbody");
  const rows = table.querySelectorAll("tr");
  const dataArray = [];

  rows.forEach(row => {
    const inputs = row.querySelectorAll("input");
    const rowData = [];
    inputs.forEach(input => {
      rowData.push(input.value.trim());
    });

    if (rowData.some(value => value !== "")) {
      dataArray.push(rowData);
    }
  });

  if (dataArray.length === 0) {
    alert("âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ lÆ°u!");
    return;
  }

  const scriptURL = "https://script.google.com/macros/s/AKfycbxROnIHnhudRi6BrpRQo27ADKiRuMwfbUzCH6-tXCijWlsMZQ4et3nM2InH8s9jQlgX/exec"; // Äáº£m báº£o Ä‘Ã¢y lÃ  URL chÃ­nh xÃ¡c cá»§a Apps Script

  fetch(scriptURL, {
    method: "POST",
    body: JSON.stringify({ data: dataArray }),
    headers: { "Content-Type": "application/json" },
  })
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        alert("âœ… Dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c lÆ°u thÃ nh cÃ´ng!");
      } else {
        alert("âŒ Lá»—i lÆ°u dá»¯ liá»‡u: " + result.message);
      }
    })
    .catch(error => {
      console.error("Lá»—i khi gá»­i yÃªu cáº§u:", error);
      alert("âŒ Lá»—i káº¿t ná»‘i tá»›i server.");
    });
}
function loadData() {
  fetch(webhookURL)
    .then(res => res.json())
    .then(data => {
      const table = document.getElementById("reasonTable").getElementsByTagName('tbody')[0];
      while (table.rows.length > 0) table.deleteRow(0); // XÃ³a táº¥t cáº£ cÃ¡c hÃ ng cÅ©

      data.forEach((obj) => {
        const row = table.insertRow();
        Object.values(obj).forEach((value, index) => {
          const cell = row.insertCell();
          const input = document.createElement("input");
          input.type = (index === 2 || index === 3 || index === 10) ? "datetime-local" : "text";
          input.value = value || "";
          input.placeholder = "è«‹è¼¸å…¥";
          input.style.backgroundColor = "#333";
          input.style.color = "#fff";
          input.style.border = "none";
          cell.appendChild(input);

          if (index === 3 || index === 10) {
            input.addEventListener("change", () => {
              calculateDays(row); // TÃ­nh toÃ¡n sá»‘ ngÃ y khi thay Ä‘á»•i ngÃ y
            });
          }
        });

        const deleteCell = row.insertCell();
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "åˆªé™¤";
        deleteBtn.className = "deleteBtn";
        deleteBtn.style.backgroundColor = "red";
        deleteBtn.style.color = "white";
        deleteBtn.onclick = function () {
          secureAction(() => {
            table.deleteRow(row.rowIndex);
          });
        };
        deleteCell.appendChild(deleteBtn);
      });

      generateSummary(data); // Cáº­p nháº­t báº£ng tÃ³m táº¯t
    })
    .catch(error => {
      console.error("Lá»—i khi táº£i dá»¯ liá»‡u:", error);
      alert("KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u!");
    });
}

function generateSummary(data) {
  const summary = {};
  data.forEach(row => {
    const month = row[0];
    const orderQty = Number(row[4]) || 0;
    const materialQty = Number(row[6]) || 0;
    if (!summary[month]) summary[month] = { orders: 0, materials: 0 };
    summary[month].orders += orderQty;
    summary[month].materials += materialQty;
  });
  const tbody = document.getElementById("summaryTable").querySelector("tbody");
  tbody.innerHTML = "";
  for (const [month, values] of Object.entries(summary)) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${month}</td><td>${values.orders}</td><td>${values.materials}</td>`;
    tbody.appendChild(tr);
  }
}
</script>
</body>
</html>
